# Redis Enhanced Configuration
# https://redis.io/docs/management/config/

# Network and Security
bind 0.0.0.0
protected-mode yes
port 6379
tcp-backlog 511
tcp-keepalive 300
timeout 0

# TLS/SSL Configuration (optional)
# tls-port 6380
# tls-cert-file /tls/redis.crt
# tls-key-file /tls/redis.key
# tls-ca-cert-file /tls/ca.crt
# tls-dh-params-file /tls/dhparam.pem

# General
daemonize no
supervised no
pidfile /var/run/redis.pid
loglevel notice
logfile ""
databases 16

# Persistence - RDB
save 900 1
save 300 10
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# Persistence - AOF
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# Memory Management
maxmemory 512mb
maxmemory-policy allkeys-lru
maxmemory-samples 5

# Lazy Freeing
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Threading
io-threads 4
io-threads-do-reads yes

# Slow Log
slowlog-log-slower-than 10000
slowlog-max-len 128

# Client Management
maxclients 10000

# ACL Configuration
# NOTE: ACL file is loaded AFTER redis.conf, so renamed commands are available
aclfile /usr/local/etc/redis/users.acl

# Security Hardening
# Rename dangerous commands to prevent misuse in production
# Commands are renamed with random suffixes instead of disabled entirely
# This allows emergency access while preventing accidental execution

# Data manipulation commands
rename-command FLUSHDB "FLUSHDB_c9d1f8e3a4b5"
rename-command FLUSHALL "FLUSHALL_d2e4f6a8c1b3"
rename-command KEYS "KEYS_f1g2h3i4j5k6"

# Configuration and control commands
rename-command CONFIG "CONFIG_a1b2c3d4e5f6"
rename-command SHUTDOWN "SHUTDOWN_e4f5a6b7c8d9"
rename-command DEBUG "DEBUG_b3c4d5e6f7a8"

# Persistence commands
rename-command BGREWRITEAOF "BGREWRITEAOF_f6a7b8c9d1e2"
rename-command BGSAVE "BGSAVE_a8b9c1d2e3f4"
rename-command SAVE "SAVE_c9d1e2f3a4b5"

# Replication commands
rename-command SLAVEOF "SLAVEOF_a4b5c6d7e8f9"
rename-command REPLICAOF "REPLICAOF_b5c6d7e8f9a1"

# Additional dangerous commands
rename-command SPOP "SPOP_d1e2f3a4b5c6"
rename-command SREM "SREM_e2f3a4b5c6d7"
rename-command RENAME "RENAME_f3a4b5c6d7e8"
rename-command RENAMENX "RENAMENX_a5b6c7d8e9f1"
rename-command DEL "DEL_b6c7d8e9f1a2"
rename-command UNLINK "UNLINK_c7d8e9f1a2b3"

# Note: These commands are still accessible via their renamed versions
# Example: To flush database, use: redis-cli FLUSHDB_c9d1f8e3a4b5
# Keep the random suffixes secret and stored in secure documentation

# Modules
# loadmodule /usr/lib/redis/modules/redisearch.so
# loadmodule /usr/lib/redis/modules/redisgraph.so
