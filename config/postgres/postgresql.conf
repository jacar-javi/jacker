# PostgreSQL Enhanced Configuration File
# Documentation: https://www.postgresql.org/docs/current/config-setting.html

# ====================================================================
# CONNECTION AND AUTHENTICATION
# ====================================================================
listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 3
authentication_timeout = 60s

# SSL Configuration (disabled - certificates not generated yet)
ssl = off
# ssl_cert_file = '/var/lib/postgresql/ssl/server.crt'
# ssl_key_file = '/var/lib/postgresql/ssl/server.key'
# ssl_ca_file = '/var/lib/postgresql/ssl/ca.crt'
# ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
# ssl_prefer_server_ciphers = on
# ssl_min_protocol_version = 'TLSv1.2'

# ====================================================================
# MEMORY CONFIGURATION
# ====================================================================
# Shared memory
shared_buffers = 256MB              # 25% of RAM for dedicated DB server
huge_pages = try                     # Use huge pages when available
temp_buffers = 8MB
work_mem = 4MB                       # Per operation memory
maintenance_work_mem = 64MB          # For VACUUM, CREATE INDEX, etc.
autovacuum_work_mem = -1            # Use maintenance_work_mem
max_stack_depth = 2MB
# shared_preload_libraries defined in EXTENSIONS section below

# Disk cache sizing
effective_cache_size = 1GB          # 50-75% of RAM

# ====================================================================
# WRITE AHEAD LOG (WAL)
# ====================================================================
wal_level = replica                 # Enables archiving and replication
fsync = on                          # Ensure data integrity
synchronous_commit = on             # Wait for WAL write
wal_sync_method = fsync
full_page_writes = on               # Recover from partial page writes
wal_compression = on                # Compress WAL
wal_buffers = 16MB
wal_writer_delay = 200ms
wal_writer_flush_after = 1MB

# WAL Archiving (for PITR backups)
archive_mode = on
archive_command = 'test ! -f /archive/%f && cp %p /archive/%f'
archive_timeout = 300               # Force archive every 5 minutes

# Checkpoints
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
checkpoint_flush_after = 256kB
checkpoint_warning = 30s
max_wal_size = 1GB
min_wal_size = 80MB

# ====================================================================
# REPLICATION
# ====================================================================
max_wal_senders = 10
wal_keep_size = 256MB
max_replication_slots = 10
max_slot_wal_keep_size = -1
track_commit_timestamp = on
hot_standby = on                    # Allow queries during recovery
hot_standby_feedback = on           # Prevent query conflicts

# ====================================================================
# QUERY TUNING
# ====================================================================
# Planner cost constants
random_page_cost = 1.1              # SSD optimization
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025
parallel_setup_cost = 1000.0
parallel_tuple_cost = 0.1
min_parallel_table_scan_size = 8MB
min_parallel_index_scan_size = 512kB

# Planner method configuration
enable_bitmapscan = on
enable_hashagg = on
enable_hashjoin = on
enable_indexscan = on
enable_indexonlyscan = on
enable_material = on
enable_mergejoin = on
enable_nestloop = on
enable_parallel_append = on
enable_seqscan = on
enable_sort = on
enable_incremental_sort = on
enable_tidscan = on
enable_partitionwise_join = off
enable_partitionwise_aggregate = off
enable_parallel_hash = on
enable_partition_pruning = on
jit = on

# Parallel query execution
max_worker_processes = 8
max_parallel_workers_per_gather = 4
max_parallel_maintenance_workers = 4
max_parallel_workers = 8
parallel_leader_participation = on

# ====================================================================
# STATISTICS
# ====================================================================
track_activities = on
track_activity_query_size = 1024
track_counts = on
track_io_timing = on
track_wal_io_timing = on
track_functions = all
stats_fetch_consistency = cache

# pg_stat_statements
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = off
pg_stat_statements.save = on

# ====================================================================
# AUTOVACUUM
# ====================================================================
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 60s
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_insert_threshold = 1000
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_vacuum_insert_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1
autovacuum_freeze_max_age = 200000000
autovacuum_multixact_freeze_max_age = 400000000
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 200

# ====================================================================
# CLIENT CONNECTION DEFAULTS
# ====================================================================
search_path = '"$user", public'
row_security = off
default_tablespace = ''
default_toast_compression = 'lz4'
temp_tablespaces = ''
default_table_access_method = 'heap'
check_function_bodies = on
default_transaction_isolation = 'read committed'
default_transaction_read_only = off
default_transaction_deferrable = off
session_replication_role = 'origin'

# Statement behavior
statement_timeout = 0               # Disabled, set per session if needed
lock_timeout = 0
idle_in_transaction_session_timeout = 300000  # 5 minutes
idle_session_timeout = 0
vacuum_freeze_table_age = 150000000
vacuum_freeze_min_age = 50000000
vacuum_failsafe_age = 1600000000
vacuum_multixact_freeze_table_age = 150000000
vacuum_multixact_freeze_min_age = 5000000
vacuum_multixact_failsafe_age = 1600000000
bytea_output = 'hex'
xmlbinary = 'base64'
xmloption = 'content'
gin_pending_list_limit = 4MB

# Locale and formatting
datestyle = 'iso, mdy'
intervalstyle = 'postgres'
timezone = 'UTC'
timezone_abbreviations = 'Default'
extra_float_digits = 1
client_encoding = 'UTF8'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# ====================================================================
# LOCK MANAGEMENT
# ====================================================================
deadlock_timeout = 1s
max_locks_per_transaction = 64
max_pred_locks_per_transaction = 64
max_pred_locks_per_relation = -2
max_pred_locks_per_page = 2

# ====================================================================
# ERROR REPORTING AND LOGGING
# ====================================================================
# Where to log - Docker best practice: log to stderr (stdout)
log_destination = 'stderr'
logging_collector = off
# log_directory = '/var/lib/postgresql/data/pg_log'  # Not needed with logging_collector = off
# log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
# log_file_mode = 0640
# log_rotation_age = 1d
# log_rotation_size = 100MB
# log_truncate_on_rotation = on

# When to log
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000   # Log slow queries (>1s)
log_min_duration_sample = -1
log_statement_sample_rate = 1.0
log_transaction_sample_rate = 0.0
log_startup_progress_interval = 10s

# What to log
debug_print_parse = off
debug_print_rewritten = off
debug_print_plan = off
debug_pretty_print = on
log_autovacuum_min_duration = 0
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_error_verbosity = default
log_hostname = off
log_line_prefix = '%m [%p] %q%u@%d '
log_lock_waits = on
# log_parameter_max_bytes = -1  # Not supported in PostgreSQL 17
log_parameter_max_length = -1
log_recovery_conflict_waits = off
log_statement = 'none'
log_replication_commands = off
log_temp_files = -1
log_timezone = 'UTC'

# ====================================================================
# RUNTIME STATISTICS
# ====================================================================
compute_query_id = auto
log_parser_stats = off
log_planner_stats = off
log_executor_stats = off
log_statement_stats = off

# ====================================================================
# QUERY/INDEX STATISTICS COLLECTOR
# ====================================================================
# stats_temp_directory = '/var/run/postgresql/pg_stat_tmp'  # Removed in PostgreSQL 15

# ====================================================================
# SECURITY
# ====================================================================
row_security = off
password_encryption = scram-sha-256

# ====================================================================
# VERSION/PLATFORM COMPATIBILITY
# ====================================================================
array_nulls = on
backslash_quote = safe_encoding
escape_string_warning = on
lo_compat_privileges = off
quote_all_identifiers = off
standard_conforming_strings = on
synchronize_seqscans = on

# ====================================================================
# EXTENSIONS
# ====================================================================
shared_preload_libraries = 'pg_stat_statements,auto_explain'

# auto_explain configuration
auto_explain.log_min_duration = '1s'
auto_explain.log_analyze = on
auto_explain.log_buffers = on
auto_explain.log_timing = on
auto_explain.log_triggers = on
auto_explain.log_verbose = on
auto_explain.log_format = 'json'
auto_explain.sample_rate = 0.1