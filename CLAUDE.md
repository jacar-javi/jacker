# Jacker Codebase Guide

This document provides essential information for Claude Code instances working on the Jacker project.

## What is Jacker?

Jacker is a Docker-based home server management platform that provides:
- Reverse proxy with Traefik v3
- OAuth2 authentication via Google
- Security with CrowdSec IPS
- Monitoring stack (Prometheus, Grafana, Loki, Promtail, Alertmanager)
- Service management dashboard (Homepage)
- Container management (Portainer)
- Code editing (VS Code Server)

## Common Commands

All management commands use Make. Key commands:

```bash
# Installation and setup
make install                  # Fresh install with mode selector (Quick/Advanced)
make reinstall                # Reinstall preserving .env configuration

# Reconfiguration (NEW)
make reconfigure-oauth        # Update OAuth credentials
make reconfigure-ssl          # Update Let's Encrypt email
make reconfigure-domain       # Change hostname/domain

# Service management
make up                       # Start all services
make down                     # Stop all services
make restart                  # Restart all services
make ps                       # List running containers
make logs                     # View logs (all services)
make logs SVC=traefik         # View logs for specific service

# Maintenance
make backup                   # Backup configuration and data
make clean                    # Remove containers and volumes
make health                   # Run health check diagnostics

# Development
make lint                     # Run shellcheck on scripts
make test                     # Run automated tests
```

## Project Architecture

### Docker Compose Modular Structure

The project uses a modular Docker Compose architecture with service inclusion:

```yaml
# docker-compose.yml (main file)
include:
  - path: compose/socket-proxy.yml
  - path: compose/traefik.yml
  - path: compose/oauth.yml
  # ... 16 other service definitions
```

**Key Services:**
- `socket-proxy.yml` - Docker socket proxy (Tecnativa) for security
- `traefik.yml` - Reverse proxy with dynamic routing
- `oauth.yml` - OAuth2 authentication (Thomseddon/oauth2_proxy)
- `crowdsec.yml` - IPS/IDS security
- `postgres.yml` - Database for CrowdSec
- `loki.yml` / `promtail.yml` - Log aggregation
- `grafana.yml` - Monitoring dashboards
- `prometheus.yml` - Metrics collection
- `alertmanager.yml` - Alert routing

### Directory Structure

```
/workspaces/jacker/
â”œâ”€â”€ assets/              # Setup and utility scripts
â”‚   â”œâ”€â”€ setup.sh        # Main installation orchestrator
â”‚   â”œâ”€â”€ 01-tune_system.sh
â”‚   â”œâ”€â”€ 02-install_docker.sh
â”‚   â”œâ”€â”€ 03-setup_ufw.sh
â”‚   â”œâ”€â”€ 04-install_assets.sh
â”‚   â”œâ”€â”€ 05-install_firewall-bouncer.sh
â”‚   â”œâ”€â”€ backup.sh
â”‚   â”œâ”€â”€ health-check.sh
â”‚   â”œâ”€â”€ check-jacker-config.sh
â”‚   â”œâ”€â”€ fix-*.sh        # Various fix scripts
â”‚   â””â”€â”€ templates/      # Config templates
â”œâ”€â”€ compose/            # Service definitions (19 files)
â”œâ”€â”€ data/               # Persistent data volumes
â”‚   â”œâ”€â”€ traefik/
â”‚   â”œâ”€â”€ loki/
â”‚   â”œâ”€â”€ grafana/
â”‚   â”œâ”€â”€ crowdsec/
â”‚   â”œâ”€â”€ postgres/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ .env                # User configuration (generated)
â”œâ”€â”€ .env.defaults       # Configuration defaults
â”œâ”€â”€ docker-compose.yml  # Main compose file
â”œâ”€â”€ Makefile           # Management commands
â””â”€â”€ README.md          # User documentation
```

## Key Technical Patterns

### 1. Environment Variables

All configuration through `.env` file (generated from `.env.defaults`):

**Critical Variables:**
- `DOMAINNAME` - Base domain (e.g., `example.com`)
- `PUBLIC_FQDN` - Full hostname (e.g., `mybox.example.com`)
- `OAUTH_CLIENT_ID` / `OAUTH_CLIENT_SECRET` - Google OAuth credentials (default auth)
- `OAUTH_WHITELIST` - Comma-separated allowed emails
- `LETSENCRYPT_EMAIL` - For SSL certificate generation
- `POSTGRES_DB` / `POSTGRES_USER` / `POSTGRES_PASSWORD` - Database config (CrowdSec uses these)

**Optional Authentik Variables** (self-hosted authentication alternative):
- `AUTHENTIK_SECRET_KEY` - Authentik secret (generated by setup-authentik.sh)
- `AUTHENTIK_POSTGRES_PASSWORD` - Authentik database password
- `AUTHENTIK_API_TOKEN` - For Homepage widget integration
- See: `./assets/setup-authentik.sh` and `jacker-docs/docs/guides/authentik.md`

**Path Variables:**
- `USERDIR` - User home directory
- `DOCKERDIR` - Jacker installation directory
- `DATADIR` - Persistent data directory (usually `$DOCKERDIR/data`)

### 2. Traefik Routing Pattern

Services use Traefik labels for dynamic routing:

```yaml
labels:
  - "traefik.enable=true"
  - "traefik.http.routers.servicename.rule=Host(`servicename.${PUBLIC_FQDN}`)"
  - "traefik.http.routers.servicename.entrypoints=websecure"
  - "traefik.http.routers.servicename.tls=true"
  - "traefik.http.routers.servicename.middlewares=chain-oauth@file"
```

**Middleware Chains:**
- `chain-oauth@file` - OAuth authentication required (default for sensitive services)
- `chain-no-auth@file` - No authentication (public services)

### 3. Authentication Flow

Jacker supports two authentication methods:

#### A. Google OAuth (Default)

1. User accesses `https://service.domain.com`
2. Traefik routes to OAuth2 Proxy middleware
3. OAuth2 Proxy checks session cookie
4. If no session â†’ redirect to Google OAuth
5. If session valid â†’ forward to backend service

**OAuth Secrets File:**
`data/traefik/rules/middlewares-oauth.yml` must contain:
```yaml
http:
  middlewares:
    oauth:
      forwardAuth:
        address: "http://oauth:4181"
        trustForwardHeader: true
        authResponseHeaders:
          - "X-Forwarded-User"
```

#### B. Authentik (Self-Hosted Alternative)

**Setup:**
```bash
# Automated setup (recommended)
./assets/setup-authentik.sh

# This will:
# 1. Generate AUTHENTIK_SECRET_KEY and AUTHENTIK_POSTGRES_PASSWORD
# 2. Add variables to .env
# 3. Uncomment compose/authentik.yml in docker-compose.yml
# 4. Create required directories
# 5. Start Authentik services
```

**Configuration:**
- Authentik runs at `https://auth.yourdomain.com`
- Uses forward authentication like OAuth
- Traefik middleware: `chain-authentik@file`
- Full docs: `jacker-docs/docs/guides/authentik.md`
- Migration guide: `jacker-docs/docs/guides/authentik-migration.md`

**Key Differences:**
- OAuth: External (Google), simple, limited customization
- Authentik: Self-hosted, advanced (MFA, LDAP, SAML), full control

### 4. Script Self-Location Detection

All scripts in `assets/` use this pattern to find the Jacker directory:

```bash
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
if [[ "$SCRIPT_DIR" == */assets ]]; then
    JACKER_DIR="$(dirname "$SCRIPT_DIR")"
else
    JACKER_DIR="$SCRIPT_DIR"
fi
cd "$JACKER_DIR" || exit 1
```

This allows scripts to work regardless of working directory.

### 5. Loki Permission Requirements

**Critical:** Loki runs as UID 10001 and requires write access to:
- `data/loki/data/chunks`
- `data/loki/data/rules`
- `data/loki/data/compactor`

**Solution:** `chmod -R 777 data/loki/data` (applied in setup.sh)

### 6. Promtail Label Cardinality

**Problem:** Broad labelmap rules can create 20+ labels per log line, causing HTTP 400 errors from Loki.

**Solution:** Use selective label mapping (7 essential labels):
- container_name
- compose_project
- compose_service
- source (stream)
- filename
- host
- app_group / app_name (optional)

See `data/loki/promtail-config.yml` and `assets/fix-promtail-labels.sh`

### 7. PostgreSQL Initialization

CrowdSec requires PostgreSQL. Setup ensures:
1. Database exists (`POSTGRES_DB=crowdsec_db`)
2. User exists (`POSTGRES_USER=crowdsec`)
3. Password set (`POSTGRES_PASSWORD`)
4. Health check waits for PostgreSQL ready

See `assets/setup.sh` function `second_round()` lines 669-709

### 8. Let's Encrypt Certificate Generation

Traefik handles automatic SSL via Let's Encrypt:

**Requirements:**
- Valid `LETSENCRYPT_EMAIL` in .env
- Real domain name (not `example.com`)
- DNS A/AAAA records pointing to server
- Ports 80/443 accessible

**Certificates stored:** `data/traefik/acme/acme.json` (must be chmod 600)

## Installation Flow

### Setup Modes (NEW - October 2025)

Jacker now offers two installation modes to reduce user friction:

#### Quick Setup Mode ðŸš€
**Purpose:** Get running in <1 minute with minimal input

**User Input Required:**
- Domain name (default: `hostname.localhost`)
- Confirmation

**Auto-Detected:**
- Hostname from system (`hostname -s`)
- Timezone from `/etc/timezone`
- PUID/PGID from current user
- All system paths
- Network subnets (uses defaults)

**Auto-Generated:**
- All secrets (PostgreSQL, CrowdSec, OAuth secret)

**Skipped (can configure later):**
- OAuth credentials â†’ Use `make reconfigure-oauth`
- Let's Encrypt SSL â†’ Use `make reconfigure-ssl`
- Alerting config â†’ Optional

**Result:**
- Services run without OAuth (unauthenticated - testing only)
- Self-signed SSL certificates
- Ready for local development/testing

#### Advanced Setup Mode ðŸ”§
**Purpose:** Full customization for production

**Same as original setup with enhancements:**
- All prompts available
- OAuth/SSL clearly marked as optional
- Better hostname auto-detection
- Can skip optional features

### Setup Script (`assets/setup.sh`)

**Entry Point:** `create_env_files()`
1. Shows mode selector menu
2. User selects Quick [1] or Advanced [2]
3. Delegates to `quick_setup()` or `advanced_setup()`
4. Both call `finalize_configuration()` for shared setup

**Functions:**
- `quick_setup()` - Minimal prompts, auto-detection
- `advanced_setup()` - Full customization
- `finalize_configuration()` - Shared config generation

**Phases:**

1. **first_round()** - Initial setup:
   - Detect OS, install dependencies
   - Create directory structure
   - Generate .env (via quick or advanced mode)
   - Configure UFW firewall (optional)
   - Create service configurations
   - Start Docker stack
   - Add script to bashrc for post-reboot continuation

2. **second_round()** - Post-reboot setup:
   - Verify PostgreSQL running
   - Create CrowdSec database if needed
   - Install CrowdSec firewall bouncer
   - Clean up bashrc entry
   - Complete installation

### Directory Creation

Critical directories created in setup.sh (lines 528-575):

```bash
# Traefik
mkdir -p data/traefik/{rules,acme}
chmod 600 data/traefik/acme/acme.json

# CrowdSec
mkdir -p data/crowdsec/config/parsers/s02-enrich
mkdir -p data/crowdsec/data

# Loki (UID 10001 needs write access)
mkdir -p data/loki/data/{rules,chunks,compactor}
chmod -R 777 data/loki/data

# Grafana
mkdir -p data/grafana/data
```

### Configuration Templates

Templates in `assets/templates/` use `envsubst` for variable substitution:

```bash
envsubst < assets/templates/config.yaml.local.template > data/crowdsec/config/config.yaml.local
envsubst < assets/templates/loki-config.yml.template > data/loki/loki-config.yml
```

## Common Issues and Solutions

### Issue: 404 Errors on All Endpoints

**Cause:** OAuth not configured (empty `OAUTH_CLIENT_ID` in .env)

**Fix:**
1. Configure Google OAuth or
2. Disable OAuth: `./assets/disable-oauth-for-testing.sh`

### Issue: HTTP 400 Error on Traefik Dashboard

**Cause:** OAuth middleware blocking access without credentials

**Fix:** See "404 Errors" above

### Issue: Invalid HTTPS Certificate

**Cause:**
- `DOMAINNAME=example.com` (placeholder domain)
- Empty `LETSENCRYPT_EMAIL`
- DNS not pointing to server

**Fix:**
1. Set real domain in .env: `DOMAINNAME=yourdomain.com`
2. Set Let's Encrypt email: `LETSENCRYPT_EMAIL=you@email.com`
3. Verify DNS records: `dig yourdomain.com`
4. Restart: `make restart`

### Issue: Cannot Access Services Despite Correct DNS

**Cause:** Domain mismatch - .env has `example.com` but accessing `vps1.yourdomain.com`

**Fix:**
1. Update .env: `DOMAINNAME=yourdomain.com` and `PUBLIC_FQDN=vps1.yourdomain.com`
2. Restart: `make restart`

### Issue: Loki Crash-Looping (Permission Denied)

**Cause:** Missing directories or wrong permissions for UID 10001

**Fix:**
```bash
./assets/fix-loki-permissions.sh
```

### Issue: Promtail HTTP 400 Errors

**Cause:** Too many labels (>20) sent to Loki

**Fix:**
```bash
./assets/fix-promtail-labels.sh
```

### Issue: CrowdSec Database Errors

**Cause:** PostgreSQL database/user mismatch

**Fix:**
```bash
./assets/fix-crowdsec-postgres.sh
# Or check manually
./assets/check-postgres-state.sh
```

### Issue: Setup Script Running on Every Login

**Cause:** Failed installations appended script path to bashrc multiple times

**Fix:**
```bash
# Remove duplicate entries
grep -v "jacker.*setup\.sh" ~/.bashrc > ~/.bashrc.tmp
mv ~/.bashrc.tmp ~/.bashrc
```

### Issue: UFW Blocks Installation

**Cause:** User declined UFW setup, script exited with code 1

**Fix:** UFW setup is now optional (exits with code 0), continues installation

## Diagnostic and Fix Scripts

### Configuration Diagnostics

```bash
./assets/check-jacker-config.sh
```
Checks:
- OAuth credentials present
- Domain configuration valid
- Let's Encrypt email set
- Secrets file exists

### Health Check

```bash
make health
# Or directly:
./assets/health-check.sh
```
Checks:
- Container status
- Network connectivity
- Volume permissions
- Service endpoints

### Backup

```bash
make backup
```
Creates timestamped backup of:
- `.env` configuration
- `data/` directory
- Traefik rules and certificates

## Editing Guidelines

### When Modifying Setup Scripts

1. **Always preserve script self-location pattern** (see pattern #4 above)
2. **Test permission requirements** (especially for Loki, Traefik acme.json)
3. **Update .env.defaults** if adding new variables
4. **Check bashrc management** (prevent duplicates)
5. **Handle reboot continuation** (first_round vs second_round)

### When Adding New Services

1. Create new file in `compose/servicename.yml`
2. Add to `docker-compose.yml` include list
3. Add Traefik labels with appropriate middleware chain
4. Document required environment variables in `.env.defaults`
5. Create data directory in setup.sh if needed
6. Update README.md with service description

### When Modifying Traefik Routing

1. Use `${PUBLIC_FQDN}` variable in Host rules: `Host(\`service.${PUBLIC_FQDN}\`)`
2. Choose appropriate middleware chain:
   - `chain-oauth@file` for authenticated services
   - `chain-no-auth@file` for public services
3. Test with OAuth disabled first: `./assets/disable-oauth-for-testing.sh`
4. Verify routing: `make logs SVC=traefik | grep "service.yourdomain.com"`

### When Troubleshooting Log Issues

1. Check Loki permissions: `ls -la data/loki/data/`
2. Check Promtail labels: `make logs SVC=promtail | grep "HTTP 400"`
3. Reduce label cardinality if needed: `./assets/fix-promtail-labels.sh`
4. Verify Loki config: `cat data/loki/loki-config.yml`

## Environment-Specific Notes

### Development Environment (Codespaces/Local)

- Working directory: `/workspaces/jacker`
- Uses Docker-in-Docker
- May use placeholder domains (`example.com`)
- OAuth often disabled for testing

### Production Environment (User Servers)

- Working directory: Variable (commonly `/home/ubuntu/jacker`)
- Always check `DOCKERDIR` variable in `.env`
- Requires real domain and DNS configuration
- OAuth authentication required for security
- Let's Encrypt SSL certificates

**Important:** When creating documentation or commands for users, always use:
- `$DOCKERDIR` instead of hardcoded paths
- Or detect: `cd "$(dirname "$(dirname "${BASH_SOURCE[0]}")")"` in scripts

## Security Considerations

1. **OAuth is Primary Security Layer** - Do not disable in production
2. **Traefik acme.json** - Must be chmod 600 (contains private keys)
3. **PostgreSQL Passwords** - Auto-generated secrets in .env
4. **CrowdSec** - IPS/IDS protection, requires PostgreSQL
5. **Socket Proxy** - Restricts Docker API access from Traefik
6. **UFW Firewall** - Recommended, blocks all except HTTP/HTTPS/SSH

## Git Workflow

Main branch: `main`

Recent commits show active development on:
- Loki configuration fixes
- Alertmanager configuration
- CrowdSec database fixes
- PostgreSQL configuration
- Security improvements

When making changes:
1. Test with `make install` on fresh system
2. Verify all services start: `make ps`
3. Check logs for errors: `make logs`
4. Run health check: `make health`
5. Test OAuth flow if modified authentication

## Key Files Reference

| File | Purpose |
|------|---------|
| `docker-compose.yml` | Main compose file with service includes |
| `.env` | User configuration (generated, not in git) |
| `.env.defaults` | Default values and documentation |
| `Makefile` | Management commands |
| `assets/setup.sh` | Main installation orchestrator |
| `assets/templates/*.template` | Configuration templates |
| `compose/*.yml` | Individual service definitions |
| `data/traefik/rules/middlewares-oauth.yml` | OAuth middleware config |
| `data/loki/promtail-config.yml` | Log shipping configuration |
| `data/crowdsec/config/config.yaml.local` | CrowdSec configuration |

## Quick Troubleshooting Checklist

When user reports issues:

1. **Check container status:** `make ps`
2. **Check configuration:** `./assets/check-jacker-config.sh`
3. **Check logs:** `make logs` or `make logs SVC=<service>`
4. **Verify domain:** Ensure `.env` domain matches access URL
5. **Check OAuth:** Is it configured? Is it needed? Can we disable for testing?
6. **Check SSL:** Is `LETSENCRYPT_EMAIL` set? Is `acme.json` populated?
7. **Check permissions:** Especially `data/loki/data` (needs 777)
8. **Run health check:** `make health`

## Additional Resources

- Main README: `/workspaces/jacker/README.md`
- Setup script: `/workspaces/jacker/assets/setup.sh` (main installation logic)
- Fix scripts: `/workspaces/jacker/assets/fix-*.sh` (various issue fixes)
- Traefik docs: https://doc.traefik.io/traefik/
- CrowdSec docs: https://docs.crowdsec.net/
- Loki docs: https://grafana.com/docs/loki/

---

**Last Updated:** 2025-10-10
**Jacker Version:** Active development
**Main Branch:** main
- keep in root only CLAUDE and README md files
- project's documentation is in /jacker-docs submodule, in extended mark-down format
- commits must not include any claude reference
- do not keep SUMMARY, REVIEW, REPORT md files, resume relevant information and add to documentation